<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Setup - Scheduling Template</title>
  <script>
    let businessDetails = {
      name: '',
      phone: '',
      address: '',
      socialMedia: {},
      images: [],
      backgroundImage: '',
      googleSheetURL: '',
      password: ''
    };

    // Check for stored sheet URL and prompt password on load
    window.onload = function() {
      const storedSheetURL = localStorage.getItem('googleSheetURL');
      if (storedSheetURL) {
        businessDetails.googleSheetURL = storedSheetURL;
        promptPasswordAccess();
      }
    };

    // Function to handle form submission
    function submitBusinessInfo() {
      businessDetails.name = document.getElementById('business-name').value;
      businessDetails.phone = document.getElementById('phone').value;
      businessDetails.address = document.getElementById('address').value;
      businessDetails.socialMedia = {
        instagram: document.getElementById('instagram').value,
        tiktok: document.getElementById('tiktok').value,
        facebook: document.getElementById('facebook').value
      };
      businessDetails.backgroundImage = document.getElementById('background-image').value;

      // Collect all image URLs
      const imageInputs = document.querySelectorAll('.image-url');
      businessDetails.images = Array.from(imageInputs).map(input => input.value);

      alert('Business information successfully saved!');
      console.log(businessDetails);
    }

    // Add image URL field dynamically
    function addImageField() {
      const imageContainer = document.getElementById('image-url-container');
      const newInput = document.createElement('input');
      newInput.type = 'text';
      newInput.placeholder = 'Paste Image URL Here';
      newInput.className = 'image-url';
      newInput.style = 'width: 300px; display: block; margin-top: 10px;';
      imageContainer.appendChild(newInput);
    }

    // Handle Google Sheet URL submission
    function linkGoogleSheet() {
      const webAppURL = document.getElementById('sheet-url').value;
      if (validateWebAppURL(webAppURL)) {
        businessDetails.googleSheetURL = webAppURL;
        localStorage.setItem('googleSheetURL', webAppURL);
        updateIndexPage(webAppURL);
        promptPasswordSetup();
      } else {
        alert('Please enter a valid Google Apps Script Web App URL.');
      }
    }

    // Validate Google Apps Script Web App URL
    function validateWebAppURL(url) {
      const regex = /^https:\/\/script\.google\.com\/macros\/s\/[-\w]+\/exec$/;
      return regex.test(url);
    }

    // Prompt user for password setup
    function promptPasswordSetup() {
      const password = prompt('Set up your admin password:');
      if (password && password.trim() !== '') {
        businessDetails.password = password;
        savePasswordToGoogleSheet(password);
      } else {
        alert('Password setup is required to continue.');
      }
    }

    // Prompt user for password on page load
    function promptPasswordAccess() {
      const password = prompt('Enter your admin password:');
      if (password && password.trim() !== '') {
        verifyPassword(password);
      } else {
        alert('Access denied.');
        window.location.href = 'index.html';
      }
    }

    // Save password in cell A1 of the Google Sheet
    function savePasswordToGoogleSheet(password) {
      fetch(businessDetails.googleSheetURL, {
        method: 'POST',
        body: JSON.stringify({ row: 1, column: 1, value: password }),
        headers: { 'Content-Type': 'application/json' }
      })
        .then(response => {
          if (response.ok) {
            alert('Password successfully set. You will now be logged out.');
            window.location.href = 'index.html'; // Redirect after setup
          } else {
            alert('Failed to set password. Please try again.');
          }
        })
        .catch(error => console.error('Error saving password:', error));
    }

    // Verify password against the one stored in the Google Sheet
    function verifyPassword(password) {
      fetch(businessDetails.googleSheetURL)
        .then(response => response.json())
        .then(data => {
          const storedPassword = data.values[0][0]; // Assuming A1 contains the password
          if (password === storedPassword) {
            alert('Access granted.');
          } else {
            alert('Incorrect password.');
            window.location.href = 'index.html';
          }
        })
        .catch(error => console.error('Error verifying password:', error));
    }

    // Update index.html dynamically with Google Sheet URL
    function updateIndexPage(sheetURL) {
      localStorage.setItem('linkedSheetURL', sheetURL);
    }
  </script>
</head>
<body>
  <h1>Admin Setup</h1>

  <h2>Business Information</h2>
  <input type="text" id="business-name" placeholder="Business Name" style="width: 300px;"><br>
  <input type="text" id="phone" placeholder="Phone Number" style="width: 300px;"><br>
  <input type="text" id="address" placeholder="Business Address" style="width: 300px;"><br>

  <h2>Social Media Links</h2>
  <input type="text" id="instagram" placeholder="Instagram Profile URL" style="width: 300px;"><br>
  <input type="text" id="tiktok" placeholder="TikTok Profile URL" style="width: 300px;"><br>
  <input type="text" id="facebook" placeholder="Facebook Profile URL" style="width: 300px;"><br>

  <h2>Background Image</h2>
  <input type="text" id="background-image" placeholder="Paste Background Image URL Here" style="width: 300px;"><br>

  <h2>Business Images (Paste URLs)</h2>
  <div id="image-url-container">
    <input type="text" class="image-url" placeholder="Paste Image URL Here" style="width: 300px; display: block;">
  </div>
  <button onclick="addImageField()">+</button><br><br>

  <button onclick="submitBusinessInfo()">Save Business Info</button>

  <h2>Link Google Sheets</h2>
  <p>Paste your Google Apps Script Web App link below to link your booking system:</p>
  <input type="text" id="sheet-url" placeholder="Paste your Google Apps Script Web App URL here" style="width: 300px;"><br>
  <button onclick="linkGoogleSheet()">Confirm & Link</button>
</body>
</html>

